name: Constitution Compliance Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # æ¯å¤©UTCæ—¶é—´02:00è¿è¡Œ
    - cron: '0 2 * * *'

jobs:
  constitution-check:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: [3.11, 3.12]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r backend/requirements.txt
        pip install astroid pytest pytest-cov

    - name: Run Constitution Audit
      run: |
        cd backend
        python -m src.constitution.auditor
      env:
        PYTHONPATH: ${{ github.workspace }}/backend/src

    - name: Upload Constitution Report
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: constitution-report-${{ matrix.python-version }}
        path: docs/reports/constitution_audit_report.md
        retention-days: 30

    - name: Check Critical Issues
      run: |
        # æ£€æŸ¥æ˜¯å¦æœ‰è‡´å‘½æˆ–ä¸¥é‡é—®é¢˜
        if [ -f "docs/reports/constitution_audit_report.md" ]; then
          critical_count=$(grep -c "ðŸš¨" docs/reports/constitution_audit_report.md || echo "0")
          violation_count=$(grep -c "âŒ" docs/reports/constitution_audit_report.md || echo "0")

          if [ "$critical_count" -gt 0 ]; then
            echo "âŒ å‘çŽ° $critical_count ä¸ªè‡´å‘½åˆè§„æ€§é—®é¢˜"
            exit 1
          elif [ "$violation_count" -gt 5 ]; then
            echo "âŒ å‘çŽ° $violation_count ä¸ªä¸¥é‡åˆè§„é—®é¢˜ï¼Œè¶…è¿‡é˜ˆå€¼"
            exit 1
          else
            echo "âœ… åˆè§„æ€§æ£€æŸ¥é€šè¿‡"
          fi
        fi

    - name: Create Comment on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const path = require('path');

          const reportPath = path.join(process.env.GITHUB_WORKSPACE, 'docs', 'reports', 'constitution_audit_report.md');

          if (fs.existsSync(reportPath)) {
            const report = fs.readFileSync(reportPath, 'utf8');

            // æå–å…³é”®ä¿¡æ¯
            const lines = report.split('\n');
            const summary = lines.slice(0, 20).join('\n'); // å–å‰20è¡Œ

            const comment = `
            ## ðŸ“‹ å®ªæ³•åˆè§„æ€§æ£€æŸ¥æŠ¥å‘Š

            ${summary}

            ---

            ðŸ“„ [æŸ¥çœ‹å®Œæ•´æŠ¥å‘Š](https://github.com/${{ context.repo.owner }}/${{ context.repo.repo }}/actions/runs/${{ context.runId }})
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          }

    - name: Notify on Failure
      if: failure()
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `å®ªæ³•åˆè§„æ€§æ£€æŸ¥å¤±è´¥ - ${new Date().toISOString().split('T')[0]}`,
            body: `
            ## ðŸš¨ å®ªæ³•åˆè§„æ€§æ£€æŸ¥å¤±è´¥

            **åˆ†æ”¯**: ${context.ref}
            **æäº¤**: ${context.sha}
            **å·¥ä½œæµ**: [${context.workflow}](${context.repositoryUrl}/actions/runs/${context.runId}})

            è¯·æ£€æŸ¥å¹¶ä¿®å¤åˆè§„æ€§é—®é¢˜åŽé‡æ–°æäº¤ä»£ç ã€‚

            ### ä¿®å¤å»ºè®®
            1. æŸ¥çœ‹è¯¦ç»†çš„åˆè§„æ€§æŠ¥å‘Š
            2. ä¿®å¤è‡´å‘½å’Œä¸¥é‡çº§åˆ«çš„è¿è§„
            3. ç¡®ä¿ä»£ç ç¬¦åˆé¡¹ç›®å®ªæ³•è¦æ±‚
            4. é‡æ–°è¿è¡Œæ£€æŸ¥

            ---

            æ­¤é—®é¢˜ç”±è‡ªåŠ¨åŒ–åˆè§„æ£€æŸ¥ç³»ç»Ÿç”Ÿæˆã€‚
            `,
            labels: ['constitution-violation', 'needs-review']
          });

  performance-impact-check:
    runs-on: ubuntu-latest
    needs: constitution-check

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install astroid
        pip install pytest pytest-xdist

    - name: Run Performance Impact Analysis
      run: |
        cd backend
        python -c "
        import ast
        import time
        from pathlib import Path

        def analyze_complexity(directory):
            complexities = []
            for py_file in Path(directory).rglob('*.py'):
                if '__pycache__' in str(py_file):
                    continue
                try:
                    with open(py_file, 'r', encoding='utf-8') as f:
                        tree = ast.parse(f.read())

                    complexity = len([node for node in ast.walk(tree)
                                   if isinstance(node, (ast.If, ast.For, ast.While, ast.Try))])
                    complexities.append((str(py_file), complexity))
                except:
                    pass
            return complexities

        start_time = time.time()
        complexities = analyze_complexity('src')
        end_time = time.time()

        print(f'åˆ†æžäº† {len(complexities)} ä¸ªæ–‡ä»¶')
        print(f'å¹³å‡å¤æ‚åº¦: {sum(c for _, c in complexities) / len(complexities):.2f}')
        print(f'åˆ†æžè€—æ—¶: {end_time - start_time:.2f}s')

        # æ£€æŸ¥æ˜¯å¦æœ‰ç‰¹åˆ«å¤æ‚çš„æ–‡ä»¶
        high_complexity = [(f, c) for f, c in complexities if c > 20]
        if high_complexity:
            print('âš ï¸ å‘çŽ°é«˜å¤æ‚åº¦æ–‡ä»¶:')
            for f, c in high_complexity[:10]:
                print(f'  {f}: {c}')
        "

    - name: Report Performance Metrics
      run: |
        echo "## ðŸ“Š æ€§èƒ½å½±å“åˆ†æžç»“æžœ" >> $GITHUB_STEP_SUMMARY
        echo "åˆ†æžæ—¶é—´: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "åˆ†æžè€—æ—¶: ${{ steps.performance-impact-check.outputs.duration || 'æœªçŸ¥' }}" >> $GITHUB_STEP_SUMMARY

  compliance-score:
    runs-on: ubuntu-latest
    needs: constitution-check
    if: always()

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Calculate Compliance Score
      id: score
      run: |
        if [ -f "docs/reports/constitution_audit_report.md" ]; then
          # æå–åˆè§„æ€§è¯„åˆ†
          score=$(grep "æ€»åˆ†:" docs/reports/constitution_audit_report.md | sed 's/.*æ€»åˆ†: \([0-9.]*\)\/100.*/\1/')
          echo "compliance_score=$score" >> $GITHUB_OUTPUT
          echo "åˆè§„æ€§è¯„åˆ†: $score"
        else
          echo "compliance_score=0" >> $GITHUB_OUTPUT
          echo "åˆè§„æ€§è¯„åˆ†: 0 (æŠ¥å‘Šæœªç”Ÿæˆ)"
        fi

    - name: Update Badge
      if: github.ref == 'refs/heads/main'
      run: |
        score="${{ steps.score.outputs.compliance_score }}"

        # åˆ›å»ºå¾½ç« 
        echo "## ðŸ† åˆè§„æ€§å¾½ç« " >> $GITHUB_STEP_SUMMARY
        echo "![Constitution Compliance](https://img.shields.io/badge/Constitution%20Compliance-$score%25-blue)" >> $GITHUB_STEP_SUMMARY

        # å¯ä»¥é›†æˆåˆ°READMEä¸­
        echo "åˆè§„æ€§è¯„åˆ†: $score/100"

  quality-gate:
    runs-on: ubuntu-latest
    needs: [constitution-check, compliance-score]
    if: always()

    steps:
    - name: Quality Gate Check
      run: |
        score="${{ needs.compliance-score.outputs.compliance_score }}"

        if [ -z "$score" ]; then
          echo "âŒ æ— æ³•èŽ·å–åˆè§„æ€§è¯„åˆ†"
          exit 1
        fi

        # è½¬æ¢ä¸ºæ•´æ•°æ¯”è¾ƒ
        score_int=$(echo "$score" | cut -d. -f1)

        if [ "$score_int" -lt 70 ]; then
          echo "âŒ åˆè§„æ€§è¯„åˆ†è¿‡ä½Ž: $score (è¦æ±‚ â‰¥ 70)"
          echo "è¯·ä¿®å¤åˆè§„æ€§é—®é¢˜åŽé‡æ–°æäº¤"
          exit 1
        elif [ "$score_int" -lt 85 ]; then
          echo "âš ï¸ åˆè§„æ€§è¯„åˆ†è¾ƒä½Ž: $score (å»ºè®® â‰¥ 85)"
          echo "å»ºè®®ä¼˜åŒ–ä»£ç è´¨é‡"
        else
          echo "âœ… åˆè§„æ€§è¯„åˆ†è‰¯å¥½: $score"
        fi

    - name: Generate Quality Report
      run: |
        score="${{ needs.compliance-score.outputs.compliance_score }}"

        cat > quality-report.md << EOF
        # ðŸ“Š è´¨é‡åˆè§„æ€§æŠ¥å‘Š

        **ç”Ÿæˆæ—¶é—´**: $(date)
        **åˆ†æ”¯**: ${GITHUB_REF}
        **æäº¤**: ${GITHUB_SHA}

        ## ðŸ† åˆè§„æ€§è¯„åˆ†

        ![Constitution Compliance](https://img.shields.io/badge/Constitution%20Compliance-$score%25-blue)

        ## ðŸ“‹ è´¨é‡é—¨æ§›

        | è¯„åˆ†èŒƒå›´ | çŠ¶æ€ | å»ºè®® |
        |----------|------|------|
        | 90-100 | ä¼˜ç§€ | æŒç»­ä¿æŒ |
        | 85-89 | è‰¯å¥½ | å¯è€ƒè™‘è¿›ä¸€æ­¥ä¼˜åŒ– |
        | 70-84 | åˆæ ¼ | å»ºè®®æ”¹è¿› |
        | <70 | ä¸åˆæ ¼ | å¿…é¡»ä¿®å¤ |

        ## ðŸŽ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

        1. æŸ¥çœ‹è¯¦ç»†çš„åˆè§„æ€§å®¡è®¡æŠ¥å‘Š
        2. æ ¹æ®å»ºè®®ä¿®å¤å‘çŽ°çš„é—®é¢˜
        3. æŒç»­æ”¹è¿›ä»£ç è´¨é‡

        ---

        *æ­¤æŠ¥å‘Šç”±è‡ªåŠ¨åŒ–è´¨é‡æŽ§åˆ¶ç³»ç»Ÿç”Ÿæˆ*
        EOF

        echo "è´¨é‡æŠ¥å‘Šå·²ç”Ÿæˆ"

    - name: Upload Quality Report
      uses: actions/upload-artifact@v3
      with:
        name: quality-report
        path: quality-report.md
        retention-days: 30